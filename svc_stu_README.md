
## 概述

学生服务（svc_stu）是面向计算机实验课程云开发平台的学生端接口，提供登录认证、个人信息管理、代码空间（容器开发环境）控制等核心功能。服务基于 Flask 框架实现 RESTful API，学生通过 API 密钥认证后可访问专属功能。

 **服务版本** ：0.2.0
 **运行端口** ：默认 5002（可通过配置修改）
 **技术栈** ：Flask、Flask-OpenAPI3、Pydantic、asyncio

## 目录

* [认证机制]()
* [核心接口]()
  * [登录认证]()
  * [用户信息管理]()
  * [代码空间管理]()
* [数据模型]()
* [错误响应]()
* [使用示例]()
* [配置说明]()
* [注意事项]()

## 认证机制

除登录接口外，所有接口均需通过 API 密钥（X-API-KEY）认证，支持三种传递方式（优先级：header > cookie > query）：

| 传递方式   | 格式                    | 示例                                               |
| ---------- | ----------------------- | -------------------------------------------------- |
| Header     | `X-API-KEY: <密钥值>` | `X-API-KEY: abc123xyz`                           |
| Cookie     | `X-API-KEY=<密钥值>`  | 浏览器 Cookie 中设置键值对                         |
| Query 参数 | `?X-API-KEY=<密钥值>` | `http://localhost:5002/user?X-API-KEY=abc123xyz` |

 **API 密钥获取** ：通过 `/login`接口提交学号和密码后生成，无明确过期时间（需通过管理员配置控制）。

## 核心接口

### 登录认证

用于学生登录系统并获取 API 密钥，是访问其他接口的前提。

#### 1. 学生登录

* **HTTP 方法** ：POST
* **路径** ：`/login`
* **功能** ：验证学生身份并返回 API 密钥（X-API-KEY）。
* **请求体** ：
  json

```json
  {  
    "sid": "2023001",  // 学生ID（学号）  
    "pwd": "Password123"  // 密码  
  }  
```

* **响应格式** ：
* 状态码：200（登录成功）
* 内容：API 密钥字符串（如 `abc123xyz`）
* 错误响应：
  * 401（密码错误）
  * 403（学生 ID 不存在）

### 用户信息管理

用于学生查询、修改个人信息及重置密码。

#### 1. 获取当前用户信息

* **HTTP 方法** ：GET
* **路径** ：`/user`
* **功能** ：查询当前登录学生的个人信息（姓名、邮箱等）。
* **请求参数** ：需通过认证（X-API-KEY）
* **响应格式** ：
* 状态码：200（成功）
* 内容：用户信息对象

  json

```json
  {  
    "name": "张三",  
    "mail": "zhangsan@school.com"  
  }  
```

#### 2. 修改用户信息

* **HTTP 方法** ：PUT
* **路径** ：`/user`
* **功能** ：更新当前登录学生的姓名或邮箱。
* **请求参数** ：需通过认证（X-API-KEY）
* **请求体** ：
  json

```json
  {  
    "name": "张三三",  // 新姓名（可选）  
    "mail": "zhangsan3@school.com"  // 新邮箱（可选）  
  }  
```

* **响应格式** ：
* 状态码：200（修改成功）
* 错误响应：
  * 400（修改内容不合法，如邮箱格式错误）
  * 403（API 密钥无效或学生不存在）

#### 3. 重置密码

* **HTTP 方法** ：PATCH
* **路径** ：`/user`
* **功能** ：通过旧密码验证后修改为新密码。
* **请求参数** ：需通过认证（X-API-KEY）
* **请求体** ：
  json

```json
  {  
    "old_pwd": "Password123",  // 旧密码  
    "new_pwd": "NewPass456"    // 新密码  
  }  
```

* **响应格式** ：
* 状态码：200（修改成功）
* 错误响应：
  * 400（旧密码错误）
  * 403（API 密钥无效）

### 代码空间管理

用于学生控制自己的代码空间（容器开发环境），包括启动、停止、查看状态等操作。

#### 1. 进入代码空间

* **HTTP 方法** ：GET
* **路径** ：`/codespace`
* **功能** ：根据代码空间状态重定向到对应的页面（开发环境页面或管理页面）。
* **请求参数** ：需通过认证（X-API-KEY）
* **响应格式** ：
* 状态码：302（代码空间运行中，重定向到开发环境 URL）
* 状态码：303（代码空间未运行，重定向到代码空间管理页面）
* 状态码：307（代码空间运行中但 URL 未就绪，重定向到管理页面）

#### 2. 启动代码空间

* **HTTP 方法** ：POST
* **路径** ：`/codespace`
* **功能** ：启动当前学生的代码空间（异步操作，立即返回结果，不等待启动完成）。
* **请求参数** ：需通过认证（X-API-KEY）
* **响应格式** ：
* 状态码：200（启动操作已触发）
* 状态码：202（代码空间已在运行中）
* 错误响应：
  * 402（时间配额已耗尽）
  * 500（启动失败，如集群异常）

#### 3. 停止代码空间

* **HTTP 方法** ：DELETE
* **路径** ：`/codespace`
* **功能** ：停止当前学生的代码空间（异步操作，立即返回结果）。
* **请求参数** ：需通过认证（X-API-KEY）
* **响应格式** ：
* 状态码：200（停止操作已触发）
* 状态码：202（代码空间已停止）
* 错误响应：500（停止失败，如集群异常）

#### 4. 获取代码空间信息

* **HTTP 方法** ：GET
* **路径** ：`/codespace/info`
* **功能** ：查询当前学生代码空间的状态、配额使用情况等信息。
* **请求参数** ：需通过认证（X-API-KEY）
* **响应格式** ：
* 状态码：200（成功）
* 内容：代码空间信息对象

  json

```json
  {  
    "access_url": "http://codespace/2023001",  // 访问URL（运行中）或false（未运行）  
    "last_start": 1685574000,  // 最近启动时间（Unix时间戳）  
    "last_stop": 1685577600,   // 最近停止时间（Unix时间戳）  
    "time_quota": 3600,        // 总时间配额（秒）  
    "time_used": 1200,         // 已使用时间（秒）  
    "space_quota": 0,          // 空间配额（字节，暂不支持）  
    "space_used": 0            // 已用空间（字节，暂不支持）  
  }  
```

#### 5. 保持代码空间活跃

* **HTTP 方法** ：POST
* **路径** ：`/codespace/keepalive`
* **功能** ：更新代码空间的活跃时间，防止因长时间未操作被自动回收。
* **请求参数** ：需通过认证（X-API-KEY）
* **响应格式** ：
* 状态码：200（操作成功，代码空间保持活跃）
* 状态码：202（代码空间未运行，无需保持活跃）
* 错误响应：500（操作失败）

## 数据模型

以下为核心数据模型的字段说明，用于请求体或响应内容的格式定义。

### 1. LoginBody（登录请求）

| 字段 | 类型   | 描述            |
| ---- | ------ | --------------- |
| sid  | string | 学生 ID（学号） |
| pwd  | string | 密码            |

### 2. UserInfo（用户信息）

| 字段 | 类型   | 描述                       |
| ---- | ------ | -------------------------- |
| name | string | 学生姓名                   |
| mail | string | 学生邮箱（需符合格式规范） |

### 3. UserResetPassword（密码重置请求）

| 字段    | 类型   | 描述                       |
| ------- | ------ | -------------------------- |
| old_pwd | string | 旧密码（用于验证身份）     |
| new_pwd | string | 新密码（需符合复杂度要求） |

### 4. CodespaceInfo（代码空间信息）

| 字段        | 类型          | 描述                                       |
| ----------- | ------------- | ------------------------------------------ |
| access_url  | string / bool | 访问 URL（运行中为字符串，未运行为 false） |
| last_start  | float         | 最近启动时间（Unix 时间戳）                |
| last_stop   | float         | 最近停止时间（Unix 时间戳）                |
| time_quota  | float         | 总时间配额（秒）                           |
| time_used   | float         | 已使用时间（秒）                           |
| space_quota | int           | 空间配额（字节，预留字段）                 |
| space_used  | int           | 已用空间（字节，预留字段）                 |

## 错误响应

所有接口的错误响应均为文本格式，状态码及说明如下：

| 状态码 | 描述                      | 示例                                                                             |
| ------ | ------------------------- | -------------------------------------------------------------------------------- |
| 401    | 未提供 API 密钥或登录失败 | `UNAUTHORIZED: please set the 'X-API-KEY' in headers...` 或 `wrong password` |
| 403    | API 密钥无效或学生不存在  | `API-KEY无效` 或 `student not found`                                         |
| 402    | 时间配额耗尽              | `代码空间配额已耗尽`                                                           |
| 400    | 请求参数错误              | `旧密码错误` 或 `修改内容不合法`                                             |
| 500    | 服务器内部错误            | `启动代码空间失败`                                                             |

## 使用示例

以下为 Python 请求示例，需替换实际的学号、密码和 API 密钥。

### 示例 1：登录并获取用户信息

```python
import requests  

# 登录获取API密钥  
login_response = requests.post(  
    "http://localhost:5002/login",  
    json={"sid": "2023001", "pwd": "Password123"}  
)  
api_key = login_response.text  # 提取API密钥字符串  

# 获取用户信息  
headers = {"X-API-KEY": api_key}  
user_response = requests.get(  
    "http://localhost:5002/user",  
    headers=headers  
)  
print(user_response.json())  # 输出用户信息（姓名、邮箱）  
```

### 示例 2：启动代码空间并查询状态

```python
import requests  

headers = {"X-API-KEY": "abc123xyz"}  # 替换为实际API密钥  

# 启动代码空间  
start_response = requests.post(  
    "http://localhost:5002/codespace",  
    headers=headers  
)  
print(start_response.status_code)  # 200表示启动操作已触发  

# 查询代码空间信息  
info_response = requests.get(  
    "http://localhost:5002/codespace/info",  
    headers=headers  
)  
print(info_response.json())  # 输出状态、配额等信息  
```

### 示例 3：重置密码

```python
import requests  

headers = {"X-API-KEY": "abc123xyz"}  

# 提交密码修改请求  
reset_response = requests.patch(  
    "http://localhost:5002/user",  
    json={  
        "old_pwd": "Password123",  
        "new_pwd": "NewPass456"  
    },  
    headers=headers  
)  
print(reset_response.status_code)  # 200表示修改成功  
```

## 配置说明

服务配置通过 `config.py`文件定义，核心配置项如下：

| 配置项                        | 说明                                                    | 默认值           |
| ----------------------------- | ------------------------------------------------------- | ---------------- |
| `CONFIG.log_dir`            | 日志存储目录                                            | `./logs`       |
| `CONFIG.SVC_STU.static_dir` | 静态资源目录（如前端页面）                              | 由系统自动配置   |
| `ENVIRON.mock_cluster`      | 是否启用集群模拟（开发环境用）                          | `False`        |
| 服务端口                      | 通过启动参数 `--port`指定                             | 5002             |
| 调试模式                      | 通过启动参数 `--nodbg`控制（`--nodbg`表示关闭调试） | 启用（开发环境） |

## 注意事项

1. **API 密钥安全** ：API 密钥是学生访问系统的凭证，需妥善保管，避免泄露给他人（否则可能导致代码空间被恶意操作）。
2. **代码空间状态** ：启动 / 停止代码空间为异步操作，接口返回成功不代表操作已完成，需通过 `/codespace/info`查询最终状态。
3. **配额管理** ：时间配额耗尽后无法启动代码空间，需联系管理员调整配额。
5. **开发环境提示** ：开发阶段可启用 `mock_cluster`模拟集群，无需依赖真实 Kubernetes 环境即可调试接口。

通过上述接口，学生可便捷地管理个人信息、控制代码空间，完成实验课程任务。
