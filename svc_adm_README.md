## 概述

管理员服务（svc_adm）是面向计算机实验课程云开发平台的后端管理接口，提供学生账户管理、代码空间（容器环境）控制、配额调整等核心功能。服务基于 Flask 框架实现，通过 RESTful API 暴露接口，仅允许管理员通过 API 密钥认证后访问。

 **服务版本** ：0.2.0
 **运行端口** ：默认 5001（可通过配置修改）
 **技术栈** ：Flask、Flask-OpenAPI3、Pydantic、asyncio

## 目录

* [认证机制]()
* [核心接口]()
  * [学生管理]()
  * [代码空间管理]()
* [数据模型]()
* [错误响应]()
* [使用示例]()
* [配置说明]()
* [注意事项]()

## 认证机制

所有接口均需通过 API 密钥认证，支持三种传递方式（优先级：header > cookie > query）：

| 传递方式   | 格式                      | 示例                                                    |
| ---------- | ------------------------- | ------------------------------------------------------- |
| Header     | `ADM-API-KEY: <密钥值>` | `ADM-API-KEY: abc123xyz`                              |
| Cookie     | `ADM-API-KEY=<密钥值>`  | 浏览器 Cookie 中设置键值对                              |
| Query 参数 | `?ADM-API-KEY=<密钥值>` | `http://localhost:5001/student?ADM-API-KEY=abc123xyz` |

 **密钥验证逻辑** ：接口会先检查请求中是否包含 API 密钥，若未提供则返回 401；若密钥与系统存储的管理员密钥不一致，则返回 403。

## 核心接口

### 学生管理

用于管理学生账户的创建、查询、删除等操作，支持批量处理。

#### 1. 获取学生列表

* **HTTP 方法** ：GET
* **路径** ：`/student`
* **功能** ：查询所有学生的基本信息（ID、姓名、邮箱），并按学生 ID 排序。
* **请求参数** ：无
* **响应格式** ：
* 状态码：200（成功）
* 内容：学生基本信息数组


```json
  [  
    {  
      "id": "2023001",  
      "name": "张三",  
      "mail": "zhangsan@school.com"  
    },  
    {  
      "id": "2023002",  
      "name": "李四",  
      "mail": "lisi@school.com"  
    }  
  ]  
```

#### 2. 获取学生详细信息

* **HTTP 方法** ：GET
* **路径** ：`/student/<sid>`
* **功能** ：查询指定学生的详细信息（含代码空间状态、配额使用情况等）。
* **请求参数** ：
* 路径参数：`sid`（学生 ID，如 `2023001`）
* **响应格式** ：
* 状态码：200（成功）
* 内容：学生详细信息对象


```json
  {  
    "id": "2023001",  
    "name": "张三",  
    "mail": "zhangsan@school.com",  
    "status": "running",  // 代码空间状态（running/stopped/starting）  
    "url": "http://codespace/2023001",  // 代码空间访问地址  
    "time_quota": 3600,  // 总时间配额（秒）  
    "time_used": 1200,   // 已使用时间（秒）  
    "last_start": 1685574000,  // 最近启动时间（时间戳）  
    "last_stop": 1685577600,   // 最近停止时间（时间戳）  
    "last_active": 1685576000, // 最近活跃时间（时间戳）  
    "last_watch": 1685575000   // 最近监控时间（时间戳）  
  }  
```

* 错误响应：404（学生 ID 不存在）

#### 3. 批量创建学生

* **HTTP 方法** ：POST
* **路径** ：`/student`
* **功能** ：批量创建学生账户，支持同时设置初始密码和时间配额。
* **请求体** ：学生信息数组

```json
  [  
    {  
      "id": "2023003",  
      "name": "王五",  
      "mail": "wangwu@school.com",  
      "pwd": "InitPwd123",  // 初始密码  
      "time_quota": 7200    // 时间配额（秒，默认0）  
    }  
  ]  
```

* **响应格式** ：
* 状态码：200（处理完成，无论部分成功或失败）
* 内容：创建结果对象


```json
  {  
    "success": [  // 创建成功的学生  
      {  
        "id": "2023003",  
        "name": "王五",  
        "mail": "wangwu@school.com"  
      }  
    ],  
    "failed": [   // 创建失败的学生及原因  
      {  
        "id": "2023004",  
        "reason": "学生ID已存在"  
      }  
    ]  
  }  
```

#### 4. 批量删除学生

* **HTTP 方法** ：DELETE
* **路径** ：`/student`
* **功能** ：批量删除学生账户（同时清理关联的代码空间数据）。
* **请求体** ：学生 ID 数组

```json
  [  
    {"sid": "2023003"},  
    {"sid": "2023004"}  
  ]  
```

* **响应格式** ：
* 状态码：200（处理完成）
* 内容：删除结果对象


```json
  {  
    "success": ["2023003"],  // 删除成功的学生ID  
    "failed": [              // 删除失败的学生ID及原因  
      {  
        "id": "2023004",  
        "reason": "学生不存在"  
      }  
    ]  
  }  
```

### 代码空间管理

用于控制学生的代码空间（容器环境），包括启动、停止、访问、配额调整等操作，支持批量处理。

#### 1. 进入学生代码空间

* **HTTP 方法** ：GET
* **路径** ：`/student/codespace/<sid>`
* **功能** ：根据学生代码空间的状态，重定向到对应的页面（代码空间页面或管理页面）。
* **请求参数** ：
* 路径参数：`sid`（学生 ID）
* **响应格式** ：
* 状态码：302（代码空间运行中，重定向到代码空间 URL）
* 状态码：303（代码空间未运行，重定向到管理页面）
* 状态码：307（代码空间启动中，重定向到管理页面）
* 错误响应：404（学生不存在）

#### 2. 启动学生代码空间

* **HTTP 方法** ：POST
* **路径** ：`/student/codespace/<sid>`
* **功能** ：启动指定学生的代码空间（异步操作，立即返回结果，不等待启动完成）。
* **请求参数** ：
* 路径参数：`sid`（学生 ID）
* **响应格式** ：
* 状态码：200（启动操作已触发）
* 状态码：202（代码空间已在运行中）
* 错误响应：
  * 402（时间配额已耗尽）
  * 404（学生不存在）

#### 3. 停止学生代码空间

* **HTTP 方法** ：DELETE
* **路径** ：`/student/codespace/<sid>`
* **功能** ：停止指定学生的代码空间（异步操作，立即返回结果）。
* **请求参数** ：
* 路径参数：`sid`（学生 ID）
* **响应格式** ：
* 状态码：200（停止操作已触发）
* 状态码：202（代码空间已停止）
* 错误响应：404（学生不存在）

#### 4. 获取学生代码空间信息

* **HTTP 方法** ：GET
* **路径** ：`/student/codespace/info/<sid>`
* **功能** ：查询指定学生的代码空间详细信息（与 “获取学生详细信息” 返回的代码空间部分一致）。
* **请求参数** ：
* 路径参数：`sid`（学生 ID）
* **响应格式** ：
* 状态码：200（成功）
* 内容：代码空间信息对象（同学生详细信息中的代码空间字段）
* 错误响应：404（学生不存在）

#### 5. 保持学生代码空间活跃

* **HTTP 方法** ：POST
* **路径** ：`/student/keepalive/<sid>`
* **功能** ：更新学生代码空间的活跃时间，防止因超时被自动回收。
* **请求参数** ：
* 路径参数：`sid`（学生 ID）
* **响应格式** ：
* 状态码：200（操作成功）
* 状态码：202（代码空间未运行，无需保持活跃）
* 错误响应：404（学生不存在）

#### 6. 批量启动代码空间

* **HTTP 方法** ：POST
* **路径** ：`/student/codespace`
* **功能** ：批量启动多个学生的代码空间。
* **请求体** ：学生 ID 列表

```json
  {  
    "ids": ["2023001", "2023002"]  
  }  
```

* **响应格式** ：
* 状态码：200（处理完成）
* 内容：启动结果对象


```json
  {  
    "success": ["2023001"],  // 启动成功的学生ID  
    "failed": [              // 启动失败的学生ID及原因  
      {  
        "id": "2023002",  
        "reason": "代码空间已在运行"  
      },  
      {  
        "id": "2023005",  
        "reason": "学生不存在"  
      }  
    ]  
  }  
```

#### 7. 批量停止代码空间

* **HTTP 方法** ：DELETE
* **路径** ：`/student/codespace`
* **功能** ：批量停止多个学生的代码空间。
* **请求体** ：学生 ID 列表

```json
  {  
    "ids": ["2023001", "2023002"]  
  }  
```

* **响应格式** ：
* 状态码：200（处理完成）
* 内容：停止结果对象


```json
  {  
    "success": ["2023001"],  // 停止成功的学生ID  
    "failed": [              // 停止失败的学生ID及原因  
      {  
        "id": "2023002",  
        "reason": "代码空间未运行"  
      }  
    ]  
  }  
```

#### 8. 调整学生代码空间配额

* **HTTP 方法** ：PUT
* **路径** ：`/student/codespace/quota/<sid>`
* **功能** ：修改指定学生的代码空间时间配额（当前暂不支持空间配额）。
* **请求参数** ：
* 路径参数：`sid`（学生 ID）
* **请求体** ：配额设置

```json
  {  
    "time_quota": 7200,  // 新的时间配额（秒）  
    "space_quota": 0     // 预留字段，暂不支持  
  }  
```

* **响应格式** ：
* 状态码：200（配额调整成功）
* 错误响应：404（学生不存在）

## 数据模型

以下为核心数据模型的字段说明，用于请求体或响应内容的格式定义。

### 1. StudentBrief（学生基本信息）

| 字段 | 类型   | 描述                  |
| ---- | ------ | --------------------- |
| id   | string | 学生唯一 ID（如学号） |
| name | string | 学生姓名              |
| mail | string | 学生邮箱              |

### 2. StudentDetail（学生详细信息）

继承自 StudentBrief，补充代码空间相关字段：

| 字段        | 类型   | 描述                                                 |
| ----------- | ------ | ---------------------------------------------------- |
| status      | string | 代码空间状态（`running`/`stopped`/`starting`） |
| url         | string | 代码空间访问 URL（状态为 `running`时有效）         |
| time_quota  | int    | 总时间配额（秒）                                     |
| time_used   | int    | 已使用时间（秒）                                     |
| last_start  | float  | 最近启动时间（Unix 时间戳）                          |
| last_stop   | float  | 最近停止时间（Unix 时间戳）                          |
| last_active | float  | 最近活跃时间（Unix 时间戳）                          |
| last_watch  | float  | 最近监控时间（Unix 时间戳）                          |

### 3. CodespaceBatchOperation（批量操作参数）

| 字段 | 类型         | 描述                                        |
| ---- | ------------ | ------------------------------------------- |
| ids  | list[string] | 学生 ID 列表（用于批量启动 / 停止代码空间） |

### 4. CodespaceQuota（配额调整参数）

| 字段        | 类型 | 描述                       |
| ----------- | ---- | -------------------------- |
| time_quota  | int  | 时间配额（秒）             |
| space_quota | int  | 空间配额（字节，暂不支持） |

## 错误响应

所有接口的错误响应均为文本或 JSON 格式，状态码及说明如下：

| 状态码 | 描述            | 示例                                                                                    |
| ------ | --------------- | --------------------------------------------------------------------------------------- |
| 401    | 未提供 API 密钥 | `UNAUTHORIZED: please set the 'ADM-API-KEY' in headers, cookies or query parameters.` |
| 403    | API 密钥无效    | `FORBIDDEN: incorrect API-KEY`                                                        |
| 404    | 学生不存在      | `Student not found`                                                                   |
| 402    | 时间配额耗尽    | `代码空间配额已耗尽`                                                                  |

## 使用示例

以下为 Python 请求示例，需替换 `<ADM-API-KEY>`为实际密钥。

### 示例 1：获取所有学生列表

```python
import requests  

headers = {"ADM-API-KEY": "<ADM-API-KEY>"}  
response = requests.get(  
    "http://localhost:5001/student",  
    headers=headers  
)  
print(response.json())  # 输出学生列表  
```

### 示例 2：批量启动代码空间

```python
import requests  

headers = {"ADM-API-KEY": "<ADM-API-KEY>"}  
data = {"ids": ["2023001", "2023002"]}  
response = requests.post(  
    "http://localhost:5001/student/codespace",  
    json=data,  
    headers=headers  
)  
print(response.json())  # 输出启动结果  
```

### 示例 3：调整学生配额

```python
import requests  

headers = {"ADM-API-KEY": "<ADM-API-KEY>"}  
data = {"time_quota": 7200}  # 设置为2小时  
response = requests.put(  
    "http://localhost:5001/student/codespace/quota/2023001",  
    json=data,  
    headers=headers  
)  
print(response.status_code)  # 200表示成功  
```

## 配置说明

服务配置通过 `config.py`文件定义，核心配置项如下：

| 配置项                   | 说明                                                    | 默认值           |
| ------------------------ | ------------------------------------------------------- | ---------------- |
| `CONFIG.log_dir`       | 日志存储目录                                            | `./logs`       |
| `ENVIRON.mock_cluster` | 是否启用集群模拟（开发环境用）                          | `False`        |
| 服务端口                 | 通过启动参数 `--port`指定                             | 5001             |
| 调试模式                 | 通过启动参数 `--nodbg`控制（`--nodbg`表示关闭调试） | 启用（开发环境） |

## 注意事项

1. **API 密钥安全** ：管理员 API 密钥是系统核心凭证，需严格保管，避免泄露；生产环境建议定期轮换密钥。
2. **批量操作限制** ：批量创建 / 删除学生、批量启动 / 停止代码空间时，建议单次操作不超过 50 条记录，避免系统负载过高。
3. **异步操作特性** ：启动 / 停止代码空间为异步操作，接口返回成功仅表示 “操作已触发”，不代表代码空间已完成启动 / 停止（需通过 “获取代码空间信息” 接口查询最终状态）。
4. **配额生效时机** ：调整时间配额后，新配额将在学生下次启动代码空间时生效。
5. **开发环境提示** ：开发环境可启用 `mock_cluster`模拟集群，无需依赖真实 Kubernetes 集群即可调试接口。

通过上述接口，管理员可高效完成学生管理、代码空间控制等核心工作，支撑计算机实验课程的全流程管理。
